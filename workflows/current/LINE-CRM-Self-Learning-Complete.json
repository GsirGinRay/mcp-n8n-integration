{
  "name": "LINE餐廳CRM自學習機器人-完整版",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "line-crm-bot",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [120, 300],
      "id": "webhook",
      "name": "LINE Webhook",
      "webhookId": "line-crm-bot"
    },
    {
      "parameters": {
        "functionCode": "// CRM智能訊息解析器\nconst events = $input.first().json.body.events;\nif (!events || events.length === 0) {\n  return [];\n}\n\nconst event = events[0];\nconst messageData = {\n  messageText: event.message?.text || '',\n  lineUserId: event.source?.userId || 'anonymous',\n  timestamp: new Date(event.timestamp).toISOString(),\n  messageId: event.message?.id || Date.now().toString(),\n  replyToken: event.replyToken,\n  \n  // 業務意圖分析\n  intents: {\n    isReservation: /(訂位|預約|訂桌|booking)/i.test(event.message?.text || ''),\n    isMenu: /(菜單|餐點|推薦|menu)/i.test(event.message?.text || ''),\n    isVipInquiry: /(VIP|會員|優惠|折扣)/i.test(event.message?.text || ''),\n    isContact: /(電話|地址|聯絡|email)/i.test(event.message?.text || ''),\n    isComplaint: /(抱怨|不滿|問題|差|爛)/i.test(event.message?.text || ''),\n    isCompliment: /(好|棒|讚|滿意|謝謝)/i.test(event.message?.text || '')\n  },\n  \n  // 提取客戶資訊\n  extractedInfo: {\n    email: event.message?.text?.match(/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}/)?.[0] || null,\n    phone: event.message?.text?.match(/\\b(?:09|\\+886-?9)\\d{8}\\b/)?.[0] || null,\n    name: null // 需要更複雜的NLP來提取姓名\n  }\n};\n\nreturn messageData;"
      },
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [320, 300],
      "id": "parse-message",
      "name": "訊息解析器"
    },
    {
      "parameters": {
        "operation": "upsert",
        "table": "customers",
        "records": [{\n          \"line_user_id\": \"={{ $json.lineUserId }}\",\n          \"email\": \"={{ $json.extractedInfo.email }}\",\n          \"phone\": \"={{ $json.extractedInfo.phone }}\",\n          \"name\": \"={{ $json.extractedInfo.name }}\",\n          \"total_interactions\": 1,\n          \"last_interaction\": \"={{ $json.timestamp }}\"\n        }],\n        \"onConflict\": \"line_user_id\"\n      },\n      \"type\": \"n8n-nodes-base.supabase\",\n      \"typeVersion\": 1,\n      \"position\": [520, 200],\n      \"id\": \"upsert-customer\",\n      \"name\": \"更新客戶資料\"\n    },\n    {\n      \"parameters\": {\n        \"operation\": \"select\",\n        \"table\": \"customers\",\n        \"where\": \"line_user_id = '{{ $json.lineUserId }}'\",\n        \"limit\": 1\n      },\n      \"type\": \"n8n-nodes-base.supabase\",\n      \"typeVersion\": 1,\n      \"position\": [520, 300],\n      \"id\": \"get-customer\",\n      \"name\": \"獲取客戶資料\"\n    },\n    {\n      \"parameters\": {\n        \"operation\": \"select\",\n        \"table\": \"customer_conversations\",\n        \"where\": \"line_user_id = '{{ $json.lineUserId }}' AND DATE(created_at) = CURRENT_DATE\",\n        \"orderBy\": \"created_at DESC\",\n        \"limit\": 10\n      },\n      \"type\": \"n8n-nodes-base.supabase\",\n      \"typeVersion\": 1,\n      \"position\": [520, 400],\n      \"id\": \"get-conversations\",\n      \"name\": \"獲取對話歷史\"\n    },\n    {\n      \"parameters\": {\n        \"operation\": \"select\",\n        \"table\": \"knowledge_base\",\n        \"where\": \"is_active = true\",\n        \"orderBy\": \"usage_count DESC, success_rate DESC\",\n        \"limit\": 20\n      },\n      \"type\": \"n8n-nodes-base.supabase\",\n      \"typeVersion\": 1,\n      \"position\": [520, 500],\n      \"id\": \"get-knowledge\",\n      \"name\": \"獲取知識庫\"\n    },\n    {\n      \"parameters\": {\n        \"operation\": \"select\",\n        \"table\": \"ai_learning_patterns\",\n        \"where\": \"(applies_to_customer_id = '{{ $node['獲取客戶資料'].json[0]?.id }}' OR applies_to_all = true OR applies_to_vip_level = '{{ $node['獲取客戶資料'].json[0]?.vip_level }}') AND is_active = true\",\n        \"orderBy\": \"confidence_score DESC\",\n        \"limit\": 15\n      },\n      \"type\": \"n8n-nodes-base.supabase\",\n      \"typeVersion\": 1,\n      \"position\": [520, 600],\n      \"id\": \"get-ai-patterns\",\n      \"name\": \"獲取AI學習模式\"\n    },\n    {\n      \"parameters\": {\n        \"functionCode\": \"// CRM智能上下文構建器\\nconst messageData = $node['訊息解析器'].json;\\nconst customer = $node['獲取客戶資料'].json?.[0];\\nconst conversations = $node['獲取對話歷史'].json || [];\\nconst knowledge = $node['獲取知識庫'].json || [];\\nconst aiPatterns = $node['獲取AI學習模式'].json || [];\\n\\n// 構建個人化系統提示\\nlet systemPrompt = `你是「小明的餐廳」的專業AI客服助理，具備完整的CRM和自學習能力。\\n\\n【餐廳基本資訊】\\n- 店名：小明的餐廳\\n- 營業時間：週一至週日 11:00 - 22:00\\n- 地址：台北市中山區中山路 123 號\\n- 電話：02-1234-5678\\n- 服務：內用、外帶、外送（5公里內）\\n- 支付方式：現金、信用卡、Line Pay、Apple Pay\\n\\n`;\\n\\n// 客戶個人化資訊\\nif (customer) {\\n  systemPrompt += `【客戶資訊】\\\\n`;\\n  systemPrompt += `- 客戶狀態：${customer.is_vip ? `VIP${customer.vip_level}級會員 (${customer.vip_points}點)` : '一般客戶'}\\\\n`;\\n  if (customer.name) systemPrompt += `- 姓名：${customer.name}\\\\n`;\\n  if (customer.email) systemPrompt += `- Email：${customer.email}\\\\n`;\\n  systemPrompt += `- 互動次數：${customer.total_interactions}次\\\\n`;\\n  if (customer.favorite_dishes?.length > 0) {\\n    systemPrompt += `- 喜愛餐點：${customer.favorite_dishes.join(', ')}\\\\n`;\\n  }\\n  if (customer.dietary_restrictions?.length > 0) {\\n    systemPrompt += `- 飲食限制：${customer.dietary_restrictions.join(', ')}\\\\n`;\\n  }\\n  systemPrompt += `- 平均消費：NT$${customer.average_order_value || 0}\\\\n`;\\n}\\n\\n// AI學習洞察\\nif (aiPatterns.length > 0) {\\n  systemPrompt += `\\\\n【AI學習洞察】\\\\n`;\\n  aiPatterns.slice(0, 5).forEach((pattern, index) => {\\n    systemPrompt += `${index + 1}. ${pattern.pattern_description} (信心度: ${pattern.confidence_score})\\\\n`;\\n  });\\n}\\n\\n// 今日對話摘要\\nif (conversations.length > 0) {\\n  systemPrompt += `\\\\n【今日對話摘要】\\\\n`;\\n  conversations.slice(0, 3).forEach(conv => {\\n    const time = new Date(conv.created_at).toLocaleTimeString('zh-TW', {hour: '2-digit', minute: '2-digit'});\\n    systemPrompt += `${time}: \\\"${conv.user_message.substring(0, 30)}...\\\" → \\\"${conv.bot_response?.substring(0, 40)}...\\\"\\\\n`;\\n  });\\n}\\n\\n// 智能匹配知識\\nconst relevantKnowledge = knowledge.filter(k => {\\n  const messageText = messageData.messageText.toLowerCase();\\n  return k.keywords.some(keyword => messageText.includes(keyword.toLowerCase()));\\n});\\n\\nif (relevantKnowledge.length > 0) {\\n  systemPrompt += `\\\\n【相關知識庫】\\\\n`;\\n  relevantKnowledge.slice(0, 3).forEach((k, index) => {\\n    systemPrompt += `${index + 1}. Q: ${k.question}\\\\n   A: ${k.answer}\\\\n`;\\n  });\\n}\\n\\nsystemPrompt += `\\\\n【回應指導原則】\\n1. 基於客戶的VIP等級和歷史偏好提供個人化服務\\n2. 參考AI學習模式提供更精準的建議\\n3. 保持親切專業的服務態度\\n4. 如果客戶提供email或電話，記住並感謝\\n5. VIP客戶享有特殊優惠和優先服務\\n6. 對於抱怨要特別關注，對於稱讚要表達感謝\\n7. 收集有用的客戶偏好資訊用於未來服務\\n\\n請針對用戶訊息「${messageData.messageText}」提供最佳回應。`;\\n\\nreturn {\\n  systemPrompt,\\n  messageContext: {\\n    ...messageData,\\n    customer,\\n    relevantKnowledge: relevantKnowledge.slice(0, 3),\\n    hasVipStatus: customer?.is_vip || false,\\n    vipLevel: customer?.vip_level || 0\\n  }\\n};\"\n      },\n      \"type\": \"n8n-nodes-base.function\",\n      \"typeVersion\": 1,\n      \"position\": [720, 300],\n      \"id\": \"build-context\",\n      \"name\": \"CRM上下文構建\"\n    },\n    {\n      \"parameters\": {\n        \"promptType\": \"define\",\n        \"text\": \"={{ $json.messageContext.messageText }}\",\n        \"options\": {\n          \"systemMessage\": \"={{ $json.systemPrompt }}\"\n        }\n      },\n      \"type\": \"@n8n/n8n-nodes-langchain.agent\",\n      \"typeVersion\": 2.2,\n      \"position\": [920, 300],\n      \"id\": \"ai-agent\",\n      \"name\": \"CRM AI助手\"\n    },\n    {\n      \"parameters\": {\n        \"model\": {\n          \"__rl\": true,\n          \"value\": \"gpt-4o-mini\",\n          \"mode\": \"list\"\n        },\n        \"options\": {\n          \"temperature\": 0.7,\n          \"maxTokens\": 500\n        }\n      },\n      \"type\": \"@n8n/n8n-nodes-langchain.lmChatOpenAi\",\n      \"typeVersion\": 1.2,\n      \"position\": [920, 500],\n      \"id\": \"openai-model\",\n      \"name\": \"OpenAI模型\"\n    },\n    {\n      \"parameters\": {\n        \"sessionIdType\": \"customKey\",\n        \"sessionKey\": \"={{ $node['CRM上下文構建'].json.messageContext.lineUserId }}\",\n        \"contextWindowLength\": 20\n      },\n      \"type\": \"@n8n/n8n-nodes-langchain.memoryBufferWindow\",\n      \"typeVersion\": 1.3,\n      \"position\": [920, 600],\n      \"id\": \"memory\",\n      \"name\": \"客戶記憶\"\n    },\n    {\n      \"parameters\": {\n        \"functionCode\": \"// CRM學習分析器\\nconst messageContext = $node['CRM上下文構建'].json.messageContext;\\nconst aiResponse = $json.output || '';\\nconst customer = messageContext.customer;\\n\\n// 分析客戶行為模式\\nconst learningPatterns = [];\\nconst extractedInfo = {};\\n\\n// VIP相關模式分析\\nif (messageContext.intents.isVipInquiry && customer?.is_vip) {\\n  learningPatterns.push({\\n    pattern_category: 'customer-behavior',\\n    pattern_type: 'vip-engagement',\\n    pattern_name: `VIP${customer.vip_level}級客戶偏好分析`,\\n    pattern_description: `VIP客戶對會員優惠和專屬服務的關注模式`,\\n    pattern_data: {\\n      vip_level: customer.vip_level,\\n      inquiry_type: 'vip_benefits',\\n      engagement_score: 0.9\\n    },\\n    applies_to_vip_level: customer.vip_level,\\n    confidence_score: 0.85\\n  });\\n}\\n\\n// 餐點偏好分析\\nif (messageContext.intents.isMenu) {\\n  const menuKeywords = ['牛肉麵', '火鍋', '烤雞', '素食', '辣', '不辣'];\\n  const mentionedDishes = menuKeywords.filter(dish => \\n    messageContext.messageText.includes(dish)\\n  );\\n  \\n  if (mentionedDishes.length > 0) {\\n    learningPatterns.push({\\n      pattern_category: 'customer-behavior',\\n      pattern_type: 'food-preference',\\n      pattern_name: '客戶餐點偏好',\\n      pattern_description: `客戶偏好：${mentionedDishes.join(', ')}`,\\n      pattern_data: {\\n        preferred_dishes: mentionedDishes,\\n        context: 'menu_inquiry'\\n      },\\n      applies_to_customer_id: customer?.id,\\n      confidence_score: 0.8\\n    });\\n    \\n    extractedInfo.favorite_dishes = mentionedDishes;\\n  }\\n}\\n\\n// 客服品質分析\\nconst sentiment = {\\n  positive: /好|棒|讚|滿意|謝謝|不錯/.test(messageContext.messageText),\\n  negative: /不好|爛|差|不滿|抱怨|問題/.test(messageContext.messageText)\\n};\\n\\nlet customerSatisfaction = 3; // 預設中性\\nif (sentiment.positive) customerSatisfaction = 5;\\nif (sentiment.negative) customerSatisfaction = 1;\\n\\n// 如果有新的客戶資訊，準備更新\\nlet customerUpdates = {};\\nif (messageContext.extractedInfo.email && !customer?.email) {\\n  customerUpdates.email = messageContext.extractedInfo.email;\\n}\\nif (messageContext.extractedInfo.phone && !customer?.phone) {\\n  customerUpdates.phone = messageContext.extractedInfo.phone;\\n}\\nif (extractedInfo.favorite_dishes) {\\n  customerUpdates.favorite_dishes = extractedInfo.favorite_dishes;\\n}\\n\\nreturn {\\n  shouldLearn: learningPatterns.length > 0,\\n  learningPatterns,\\n  conversationData: {\\n    customer_id: customer?.id,\\n    line_user_id: messageContext.lineUserId,\\n    message_id: messageContext.messageId,\\n    user_message: messageContext.messageText,\\n    bot_response: aiResponse,\\n    detected_intent: Object.keys(messageContext.intents).find(key => messageContext.intents[key]) || 'general',\\n    confidence_score: 0.8,\\n    sentiment: sentiment.positive ? 'positive' : sentiment.negative ? 'negative' : 'neutral',\\n    customer_satisfaction: customerSatisfaction,\\n    has_business_intent: Object.values(messageContext.intents).some(Boolean),\\n    extracted_info: extractedInfo,\\n    timestamp: messageContext.timestamp\\n  },\\n  customerUpdates: Object.keys(customerUpdates).length > 0 ? customerUpdates : null,\\n  shouldUpdateCustomer: Object.keys(customerUpdates).length > 0\\n};\"\n      },\n      \"type\": \"n8n-nodes-base.function\",\n      \"typeVersion\": 1,\n      \"position\": [1120, 300],\n      \"id\": \"crm-analyzer\",\n      \"name\": \"CRM學習分析\"\n    },\n    {\n      \"parameters\": {\n        \"operation\": \"insert\",\n        \"table\": \"customer_conversations\",\n        \"records\": \"={{ [$json.conversationData] }}\"\n      },\n      \"type\": \"n8n-nodes-base.supabase\",\n      \"typeVersion\": 1,\n      \"position\": [1320, 200],\n      \"id\": \"save-conversation\",\n      \"name\": \"保存對話\"\n    },\n    {\n      \"parameters\": {\n        \"conditions\": {\n          \"options\": {\n            \"caseSensitive\": true,\n            \"leftValue\": \"\",\n            \"typeValidation\": \"strict\"\n          },\n          \"conditions\": [\n            {\n              \"leftValue\": \"={{ $json.shouldLearn }}\",\n              \"rightValue\": true,\n              \"operator\": {\n                \"type\": \"boolean\",\n                \"operation\": \"true\",\n                \"singleValue\": true\n              }\n            }\n          ],\n          \"combinator\": \"and\"\n        },\n        \"options\": {}\n      },\n      \"type\": \"n8n-nodes-base.if\",\n      \"typeVersion\": 2,\n      \"position\": [1320, 300],\n      \"id\": \"should-learn\",\n      \"name\": \"需要學習？\"\n    },\n    {\n      \"parameters\": {\n        \"operation\": \"insert\",\n        \"table\": \"ai_learning_patterns\",\n        \"records\": \"={{ $json.learningPatterns }}\"\n      },\n      \"type\": \"n8n-nodes-base.supabase\",\n      \"typeVersion\": 1,\n      \"position\": [1520, 250],\n      \"id\": \"save-patterns\",\n      \"name\": \"保存學習模式\"\n    },\n    {\n      \"parameters\": {\n        \"conditions\": {\n          \"options\": {\n            \"caseSensitive\": true,\n            \"leftValue\": \"\",\n            \"typeValidation\": \"strict\"\n          },\n          \"conditions\": [\n            {\n              \"leftValue\": \"={{ $json.shouldUpdateCustomer }}\",\n              \"rightValue\": true,\n              \"operator\": {\n                \"type\": \"boolean\",\n                \"operation\": \"true\",\n                \"singleValue\": true\n              }\n            }\n          ],\n          \"combinator\": \"and\"\n        },\n        \"options\": {}\n      },\n      \"type\": \"n8n-nodes-base.if\",\n      \"typeVersion\": 2,\n      \"position\": [1320, 400],\n      \"id\": \"should-update-customer\",\n      \"name\": \"需要更新客戶？\"\n    },\n    {\n      \"parameters\": {\n        \"operation\": \"update\",\n        \"table\": \"customers\",\n        \"updateKey\": \"line_user_id\",\n        \"records\": \"={{ [Object.assign({line_user_id: $node['CRM學習分析'].json.conversationData.line_user_id}, $node['CRM學習分析'].json.customerUpdates)] }}\"\n      },\n      \"type\": \"n8n-nodes-base.supabase\",\n      \"typeVersion\": 1,\n      \"position\": [1520, 400],\n      \"id\": \"update-customer\",\n      \"name\": \"更新客戶資料\"\n    },\n    {\n      \"parameters\": {\n        \"method\": \"POST\",\n        \"url\": \"https://api.line.me/v2/bot/message/reply\",\n        \"authentication\": \"genericCredentialType\",\n        \"genericAuthType\": \"httpHeaderAuth\",\n        \"sendBody\": true,\n        \"specifyBody\": \"json\",\n        \"jsonBody\": \"={\\n    \\\"replyToken\\\": \\\"{{ $node['CRM上下文構建'].json.messageContext.replyToken }}\\\",\\n    \\\"messages\\\": [\\n        {\\n            \\\"type\\\": \\\"text\\\",\\n            \\\"text\\\": \\\"{{ $node['CRM AI助手'].json.output.replace(/\\\\\\\\/g, '\\\\\\\\\\\\\\\\').replace(/\\\"/g, '\\\\\\\\\\\"').replace(/\\\\r?\\\\n/g, '\\\\\\\\n') }}\\\"\\n        }\\n    ]\\n}\",\n        \"options\": {}\n      },\n      \"type\": \"n8n-nodes-base.httpRequest\",\n      \"typeVersion\": 4.2,\n      \"position\": [1120, 500],\n      \"id\": \"line-reply\",\n      \"name\": \"LINE回覆\"\n    }\n  ],\n  \"connections\": {\n    \"LINE Webhook\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"訊息解析器\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"訊息解析器\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"更新客戶資料\",\n            \"type\": \"main\",\n            \"index\": 0\n          },\n          {\n            \"node\": \"獲取客戶資料\",\n            \"type\": \"main\",\n            \"index\": 0\n          },\n          {\n            \"node\": \"獲取對話歷史\",\n            \"type\": \"main\",\n            \"index\": 0\n          },\n          {\n            \"node\": \"獲取知識庫\",\n            \"type\": \"main\",\n            \"index\": 0\n          },\n          {\n            \"node\": \"獲取AI學習模式\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"獲取客戶資料\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"CRM上下文構建\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"獲取對話歷史\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"CRM上下文構建\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"獲取知識庫\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"CRM上下文構建\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"獲取AI學習模式\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"CRM上下文構建\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"CRM上下文構建\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"CRM AI助手\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"CRM AI助手\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"CRM學習分析\",\n            \"type\": \"main\",\n            \"index\": 0\n          },\n          {\n            \"node\": \"LINE回覆\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"CRM學習分析\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"保存對話\",\n            \"type\": \"main\",\n            \"index\": 0\n          },\n          {\n            \"node\": \"需要學習？\",\n            \"type\": \"main\",\n            \"index\": 0\n          },\n          {\n            \"node\": \"需要更新客戶？\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"需要學習？\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"保存學習模式\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"需要更新客戶？\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"更新客戶資料\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"OpenAI模型\": {\n      \"ai_languageModel\": [\n        [\n          {\n            \"node\": \"CRM AI助手\",\n            \"type\": \"ai_languageModel\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"客戶記憶\": {\n      \"ai_memory\": [\n        [\n          {\n            \"node\": \"CRM AI助手\",\n            \"type\": \"ai_memory\",\n            \"index\": 0\n          }\n        ]\n      ]\n    }\n  },\n  \"settings\": {\n    \"executionOrder\": \"v1\"\n  },\n  \"staticData\": null,\n  \"meta\": {},\n  \"pinData\": {},\n  \"triggerCount\": 1,\n  \"tags\": [\"crm\", \"self-learning\", \"line-bot\", \"vip\", \"supabase\"]\n}"