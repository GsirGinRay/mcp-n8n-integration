<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>📁 Google Drive 同步管理中心</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/element-plus@2.4.0/dist/index.full.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/element-plus@2.4.0/dist/index.css">
    <script src="https://unpkg.com/chart.js@4.0.0/dist/chart.umd.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .header {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
        }
        .main-container {
            max-width: 1600px;
            margin: 2rem auto;
            padding: 0 1rem;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .stat-card {
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        .stat-card:hover {
            transform: translateY(-5px);
        }
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        .content-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }
        .content-area {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        .full-width {
            grid-column: 1 / -1;
        }
        .sync-item {
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            background: #fff;
            transition: all 0.3s ease;
            position: relative;
        }
        .sync-item:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        .status-badge {
            display: inline-block;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        .status-completed { background: #f0f9ff; color: #0369a1; }
        .status-processing { background: #fef3c7; color: #d97706; }
        .status-failed { background: #fef2f2; color: #dc2626; }
        .status-pending { background: #f3f4f6; color: #6b7280; }
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 1rem;
        }
        .file-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        .file-icon {
            font-size: 2rem;
        }
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #f0f0f0;
            border-radius: 4px;
            overflow: hidden;
            margin: 0.5rem 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            transition: width 0.3s ease;
        }
        .action-buttons {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- 頂部導航 -->
        <div class="header">
            <el-row justify="space-between" align="middle">
                <el-col :span="12">
                    <h1 style="margin: 0; background: linear-gradient(45deg, #667eea, #764ba2); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                        📁 Google Drive 同步管理中心
                    </h1>
                    <p style="margin: 0.5rem 0 0 0; color: #666;">即時監控雲端文件同步狀態</p>
                </el-col>
                <el-col :span="12" style="text-align: right;">
                    <el-button type="primary" @click="refreshData" :loading="loading">
                        <i class="el-icon-refresh"></i> 刷新數據
                    </el-button>
                    <el-button type="success" @click="triggerManualSync">
                        <i class="el-icon-upload"></i> 手動同步
                    </el-button>
                    <el-button type="info" @click="showSettings = true">
                        <i class="el-icon-setting"></i> 設置
                    </el-button>
                </el-col>
            </el-row>
        </div>

        <!-- 主要內容區 -->
        <div class="main-container">
            <!-- 統計卡片 -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" style="color: #667eea;">{{ stats.totalFiles }}</div>
                    <div>📄 監控文件總數</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" style="color: #52c41a;">{{ stats.completedToday }}</div>
                    <div>✅ 今日成功同步</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" style="color: #faad14;">{{ stats.processingNow }}</div>
                    <div>⚡ 正在處理中</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" style="color: #ff4d4f;">{{ stats.failedToday }}</div>
                    <div>❌ 今日失敗</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" style="color: #722ed1;">{{ formatBytes(stats.totalDataSize) }}</div>
                    <div>💾 總數據量</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" style="color: #1890ff;">{{ stats.avgProcessingTime }}s</div>
                    <div>⏱️ 平均處理時間</div>
                </div>
            </div>

            <!-- 內容區域 -->
            <div class="content-grid">
                <!-- 同步狀態監控 -->
                <div class="content-area">
                    <h3>🔄 即時同步狀態</h3>
                    <div v-loading="loading">
                        <div v-for="sync in recentSyncs" :key="sync.id" class="sync-item">
                            <div class="file-info">
                                <div class="file-icon">{{ getFileIcon(sync.file_name) }}</div>
                                <div style="flex: 1;">
                                    <h4 style="margin: 0;">{{ sync.file_name }}</h4>
                                    <p style="margin: 0.25rem 0; color: #666; font-size: 0.9rem;">
                                        {{ formatBytes(sync.file_size_bytes) }} • 
                                        {{ formatDate(sync.last_sync_time) }}
                                    </p>
                                </div>
                                <div>
                                    <span :class="'status-badge status-' + sync.sync_status">
                                        {{ getStatusText(sync.sync_status) }}
                                    </span>
                                </div>
                            </div>
                            
                            <div v-if="sync.sync_status === 'processing'" class="progress-bar">
                                <div class="progress-fill" :style="{width: getProgressWidth(sync) + '%'}"></div>
                            </div>
                            
                            <div v-if="sync.records_imported > 0" style="color: #666; font-size: 0.9rem;">
                                📊 已導入 {{ sync.records_imported.toLocaleString() }} 筆記錄到表格：{{ sync.target_table_name }}
                            </div>
                            
                            <div v-if="sync.error_message" style="color: #ff4d4f; font-size: 0.9rem; margin-top: 0.5rem;">
                                ⚠️ {{ sync.error_message }}
                            </div>
                            
                            <div class="action-buttons">
                                <el-button size="small" @click="viewTableData(sync.target_table_name)" v-if="sync.target_table_name">
                                    查看數據
                                </el-button>
                                <el-button size="small" type="primary" @click="retrySyncIfFailed(sync)" v-if="sync.sync_status === 'failed'">
                                    重試同步
                                </el-button>
                                <el-button size="small" type="info" @click="viewSyncDetails(sync)">
                                    詳細信息
                                </el-button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 性能分析圖表 -->
                <div class="content-area">
                    <h3>📈 同步性能分析</h3>
                    <div class="chart-container">
                        <canvas ref="performanceChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- 管理表格概覽 -->
            <div class="content-area full-width">
                <h3>🗂️ 數據表管理概覽</h3>
                <el-table :data="managedTables" style="width: 100%">
                    <el-table-column prop="table_name" label="表格名稱" width="200">
                        <template #default="scope">
                            <el-link @click="viewTableData(scope.row.table_name)">
                                {{ scope.row.table_name }}
                            </el-link>
                        </template>
                    </el-table-column>
                    <el-table-column prop="display_name" label="顯示名稱" width="200">
                    </el-table-column>
                    <el-table-column prop="total_records" label="記錄數量" width="120">
                        <template #default="scope">
                            {{ scope.row.total_records?.toLocaleString() || 0 }}
                        </template>
                    </el-table-column>
                    <el-table-column prop="estimated_size_mb" label="大小" width="100">
                        <template #default="scope">
                            {{ (scope.row.estimated_size_mb || 0).toFixed(1) }} MB
                        </template>
                    </el-table-column>
                    <el-table-column prop="last_sync_time" label="最後同步" width="180">
                        <template #default="scope">
                            {{ formatDate(scope.row.last_sync_time) }}
                        </template>
                    </el-table-column>
                    <el-table-column prop="sync_status" label="狀態" width="100">
                        <template #default="scope">
                            <span :class="'status-badge status-' + scope.row.sync_status">
                                {{ getStatusText(scope.row.sync_status) }}
                            </span>
                        </template>
                    </el-table-column>
                    <el-table-column prop="data_quality_score" label="品質分數" width="120">
                        <template #default="scope">
                            <el-progress 
                                :percentage="(scope.row.data_quality_score || 0) * 100" 
                                :stroke-width="6"
                                :show-text="false">
                            </el-progress>
                            {{ ((scope.row.data_quality_score || 0) * 100).toFixed(0) }}%
                        </template>
                    </el-table-column>
                    <el-table-column label="操作" width="200">
                        <template #default="scope">
                            <el-button size="small" @click="viewTableData(scope.row.table_name)">查看</el-button>
                            <el-button size="small" type="primary" @click="exportTableData(scope.row.table_name)">導出</el-button>
                            <el-button size="small" type="danger" @click="deleteTable(scope.row)">刪除</el-button>
                        </template>
                    </el-table-column>
                </el-table>
            </div>
        </div>

        <!-- 設置對話框 -->
        <el-dialog v-model="showSettings" title="⚙️ 同步設置" width="60%">
            <el-form :model="settings" label-width="120px">
                <el-form-item label="同步頻率">
                    <el-select v-model="settings.syncSchedule">
                        <el-option label="每5分鐘" value="*/5 * * * *"></el-option>
                        <el-option label="每10分鐘" value="*/10 * * * *"></el-option>
                        <el-option label="每30分鐘" value="*/30 * * * *"></el-option>
                        <el-option label="每小時" value="0 * * * *"></el-option>
                    </el-select>
                </el-form-item>
                <el-form-item label="最大文件大小">
                    <el-input-number v-model="settings.maxFileSizeMB" :min="1" :max="1000" />
                    <span style="margin-left: 10px;">MB</span>
                </el-form-item>
                <el-form-item label="批次處理大小">
                    <el-input-number v-model="settings.batchSize" :min="100" :max="10000" :step="100" />
                </el-form-item>
                <el-form-item label="自動創建表格">
                    <el-switch v-model="settings.autoCreateTables"></el-switch>
                </el-form-item>
                <el-form-item label="失敗時通知">
                    <el-switch v-model="settings.notifyOnFailure"></el-switch>
                </el-form-item>
            </el-form>
            <template #footer>
                <el-button @click="showSettings = false">取消</el-button>
                <el-button type="primary" @click="saveSettings">保存設置</el-button>
            </template>
        </el-dialog>
    </div>

    <script>
        const { createApp } = Vue;
        const { ElMessage, ElMessageBox } = ElementPlus;

        // Supabase 配置
        const supabase = window.supabase.createClient(
            'YOUR_SUPABASE_URL',
            'YOUR_SUPABASE_ANON_KEY'
        );

        createApp({
            data() {
                return {
                    loading: false,
                    showSettings: false,
                    recentSyncs: [],
                    managedTables: [],
                    stats: {
                        totalFiles: 0,
                        completedToday: 0,
                        processingNow: 0,
                        failedToday: 0,
                        totalDataSize: 0,
                        avgProcessingTime: 0
                    },
                    settings: {
                        syncSchedule: '*/10 * * * *',
                        maxFileSizeMB: 100,
                        batchSize: 1000,
                        autoCreateTables: true,
                        notifyOnFailure: true
                    },
                    performanceChart: null
                }
            },
            async mounted() {
                await this.loadData();
                this.initPerformanceChart();
                
                // 設置自動刷新
                setInterval(() => {
                    this.refreshProcessingStatus();
                }, 30000); // 每30秒刷新處理中的同步
            },
            methods: {
                async loadData() {
                    this.loading = true;
                    try {
                        await Promise.all([
                            this.loadRecentSyncs(),
                            this.loadManagedTables(),
                            this.loadStats()
                        ]);
                    } catch (error) {
                        ElMessage.error('載入資料失敗: ' + error.message);
                    }
                    this.loading = false;
                },
                
                async loadRecentSyncs() {
                    const { data, error } = await supabase
                        .from('file_sync_log')
                        .select('*')
                        .order('last_sync_time', { ascending: false })
                        .limit(20);
                    
                    if (error) throw error;
                    this.recentSyncs = data || [];
                },
                
                async loadManagedTables() {
                    const { data, error } = await supabase
                        .from('managed_tables')
                        .select('*')
                        .order('last_sync_time', { ascending: false });
                    
                    if (error) throw error;
                    this.managedTables = data || [];
                },
                
                async loadStats() {
                    const today = new Date().toISOString().split('T')[0];
                    
                    const [files, todayStats] = await Promise.all([
                        supabase.from('file_sync_log').select('*'),
                        supabase.from('file_sync_log')
                            .select('*')
                            .gte('last_sync_time', today)
                    ]);
                    
                    const allFiles = files.data || [];
                    const todayFiles = todayStats.data || [];
                    
                    this.stats = {
                        totalFiles: allFiles.length,
                        completedToday: todayFiles.filter(f => f.sync_status === 'completed').length,
                        processingNow: allFiles.filter(f => f.sync_status === 'processing').length,
                        failedToday: todayFiles.filter(f => f.sync_status === 'failed').length,
                        totalDataSize: allFiles.reduce((sum, f) => sum + (f.file_size_bytes || 0), 0),
                        avgProcessingTime: Math.round(
                            allFiles
                                .filter(f => f.processing_time_ms)
                                .reduce((sum, f, _, arr) => sum + f.processing_time_ms / arr.length, 0) / 1000
                        )
                    };
                },
                
                async refreshProcessingStatus() {
                    // 只刷新處理中的同步狀態
                    const processingIds = this.recentSyncs
                        .filter(sync => sync.sync_status === 'processing')
                        .map(sync => sync.id);
                    
                    if (processingIds.length > 0) {
                        const { data } = await supabase
                            .from('file_sync_log')
                            .select('*')
                            .in('id', processingIds);
                        
                        if (data) {
                            data.forEach(updatedSync => {
                                const index = this.recentSyncs.findIndex(s => s.id === updatedSync.id);
                                if (index !== -1) {
                                    this.recentSyncs[index] = updatedSync;
                                }
                            });
                        }
                    }
                },
                
                getFileIcon(fileName) {
                    const ext = fileName.split('.').pop().toLowerCase();
                    switch (ext) {
                        case 'csv': return '📊';
                        case 'xlsx': case 'xls': return '📈';
                        case 'json': return '📋';
                        default: return '📄';
                    }
                },
                
                getStatusText(status) {
                    const statusMap = {
                        'completed': '已完成',
                        'processing': '處理中',
                        'failed': '失敗',
                        'pending': '等待中',
                        'active': '活躍',
                        'error': '錯誤'
                    };
                    return statusMap[status] || status;
                },
                
                getProgressWidth(sync) {
                    if (sync.sync_status !== 'processing') return 0;
                    
                    // 基於時間估算進度（簡化版）
                    const elapsed = Date.now() - new Date(sync.last_sync_time).getTime();
                    const estimated = (sync.file_size_bytes || 1000000) / 10000; // 估算處理時間
                    return Math.min(95, (elapsed / estimated) * 100);
                },
                
                formatBytes(bytes) {
                    if (!bytes) return '0 B';
                    const k = 1024;
                    const sizes = ['B', 'KB', 'MB', 'GB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
                },
                
                formatDate(dateString) {
                    if (!dateString) return '未知';
                    return new Date(dateString).toLocaleString('zh-TW');
                },
                
                async triggerManualSync() {
                    try {
                        ElMessage.info('正在觸發手動同步...');
                        // 這裡可以調用 n8n webhook 觸發同步
                        // await fetch('/webhook/trigger-sync', { method: 'POST' });
                        ElMessage.success('手動同步已觸發！');
                        setTimeout(() => this.refreshData(), 2000);
                    } catch (error) {
                        ElMessage.error('觸發同步失敗: ' + error.message);
                    }
                },
                
                viewTableData(tableName) {
                    // 開啟新視窗查看表格數據
                    window.open(`/table-viewer?table=${tableName}`, '_blank');
                },
                
                async exportTableData(tableName) {
                    try {
                        ElMessage.info('正在準備導出...');
                        const { data, error } = await supabase
                            .from(tableName)
                            .select('*')
                            .limit(10000);
                        
                        if (error) throw error;
                        
                        const csv = this.convertToCSV(data);
                        this.downloadCSV(csv, `${tableName}.csv`);
                        ElMessage.success('導出完成！');
                    } catch (error) {
                        ElMessage.error('導出失敗: ' + error.message);
                    }
                },
                
                convertToCSV(data) {
                    if (!data || data.length === 0) return '';
                    const headers = Object.keys(data[0]).join(',');
                    const rows = data.map(row => 
                        Object.values(row).map(val => `"${val}"`).join(',')
                    );
                    return [headers, ...rows].join('\n');
                },
                
                downloadCSV(csv, filename) {
                    const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = filename;
                    link.click();
                },
                
                async deleteTable(table) {
                    try {
                        await ElMessageBox.confirm(
                            `確定要刪除表格 "${table.table_name}" 嗎？此操作無法恢復！`,
                            '確認刪除'
                        );
                        
                        // 執行刪除操作
                        ElMessage.success('表格已刪除');
                        await this.loadManagedTables();
                    } catch (error) {
                        if (error !== 'cancel') {
                            ElMessage.error('刪除失敗: ' + error.message);
                        }
                    }
                },
                
                initPerformanceChart() {
                    const ctx = this.$refs.performanceChart.getContext('2d');
                    this.performanceChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: ['1h', '2h', '3h', '4h', '5h', '6h'],
                            datasets: [{
                                label: '同步成功率',
                                data: [95, 87, 92, 89, 94, 96],
                                borderColor: '#667eea',
                                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                                tension: 0.4
                            }, {
                                label: '處理速度(MB/s)',
                                data: [12, 15, 11, 18, 16, 14],
                                borderColor: '#764ba2',
                                backgroundColor: 'rgba(118, 75, 162, 0.1)',
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                },
                
                async saveSettings() {
                    try {
                        // 保存設置到 Supabase
                        ElMessage.success('設置已保存！');
                        this.showSettings = false;
                    } catch (error) {
                        ElMessage.error('保存設置失敗: ' + error.message);
                    }
                },
                
                async refreshData() {
                    await this.loadData();
                    ElMessage.success('資料已刷新！');
                }
            }
        }).use(ElementPlus).mount('#app');
    </script>
</body>
</html>