<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“ Google Drive åŒæ­¥ç®¡ç†ä¸­å¿ƒ</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/element-plus@2.4.0/dist/index.full.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/element-plus@2.4.0/dist/index.css">
    <script src="https://unpkg.com/chart.js@4.0.0/dist/chart.umd.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .header {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
        }
        .main-container {
            max-width: 1600px;
            margin: 2rem auto;
            padding: 0 1rem;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .stat-card {
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        .stat-card:hover {
            transform: translateY(-5px);
        }
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        .content-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }
        .content-area {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        .full-width {
            grid-column: 1 / -1;
        }
        .sync-item {
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            background: #fff;
            transition: all 0.3s ease;
            position: relative;
        }
        .sync-item:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        .status-badge {
            display: inline-block;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        .status-completed { background: #f0f9ff; color: #0369a1; }
        .status-processing { background: #fef3c7; color: #d97706; }
        .status-failed { background: #fef2f2; color: #dc2626; }
        .status-pending { background: #f3f4f6; color: #6b7280; }
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 1rem;
        }
        .file-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        .file-icon {
            font-size: 2rem;
        }
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #f0f0f0;
            border-radius: 4px;
            overflow: hidden;
            margin: 0.5rem 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            transition: width 0.3s ease;
        }
        .action-buttons {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- é ‚éƒ¨å°èˆª -->
        <div class="header">
            <el-row justify="space-between" align="middle">
                <el-col :span="12">
                    <h1 style="margin: 0; background: linear-gradient(45deg, #667eea, #764ba2); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                        ğŸ“ Google Drive åŒæ­¥ç®¡ç†ä¸­å¿ƒ
                    </h1>
                    <p style="margin: 0.5rem 0 0 0; color: #666;">å³æ™‚ç›£æ§é›²ç«¯æ–‡ä»¶åŒæ­¥ç‹€æ…‹</p>
                </el-col>
                <el-col :span="12" style="text-align: right;">
                    <el-button type="primary" @click="refreshData" :loading="loading">
                        <i class="el-icon-refresh"></i> åˆ·æ–°æ•¸æ“š
                    </el-button>
                    <el-button type="success" @click="triggerManualSync">
                        <i class="el-icon-upload"></i> æ‰‹å‹•åŒæ­¥
                    </el-button>
                    <el-button type="info" @click="showSettings = true">
                        <i class="el-icon-setting"></i> è¨­ç½®
                    </el-button>
                </el-col>
            </el-row>
        </div>

        <!-- ä¸»è¦å…§å®¹å€ -->
        <div class="main-container">
            <!-- çµ±è¨ˆå¡ç‰‡ -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" style="color: #667eea;">{{ stats.totalFiles }}</div>
                    <div>ğŸ“„ ç›£æ§æ–‡ä»¶ç¸½æ•¸</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" style="color: #52c41a;">{{ stats.completedToday }}</div>
                    <div>âœ… ä»Šæ—¥æˆåŠŸåŒæ­¥</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" style="color: #faad14;">{{ stats.processingNow }}</div>
                    <div>âš¡ æ­£åœ¨è™•ç†ä¸­</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" style="color: #ff4d4f;">{{ stats.failedToday }}</div>
                    <div>âŒ ä»Šæ—¥å¤±æ•—</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" style="color: #722ed1;">{{ formatBytes(stats.totalDataSize) }}</div>
                    <div>ğŸ’¾ ç¸½æ•¸æ“šé‡</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" style="color: #1890ff;">{{ stats.avgProcessingTime }}s</div>
                    <div>â±ï¸ å¹³å‡è™•ç†æ™‚é–“</div>
                </div>
            </div>

            <!-- å…§å®¹å€åŸŸ -->
            <div class="content-grid">
                <!-- åŒæ­¥ç‹€æ…‹ç›£æ§ -->
                <div class="content-area">
                    <h3>ğŸ”„ å³æ™‚åŒæ­¥ç‹€æ…‹</h3>
                    <div v-loading="loading">
                        <div v-for="sync in recentSyncs" :key="sync.id" class="sync-item">
                            <div class="file-info">
                                <div class="file-icon">{{ getFileIcon(sync.file_name) }}</div>
                                <div style="flex: 1;">
                                    <h4 style="margin: 0;">{{ sync.file_name }}</h4>
                                    <p style="margin: 0.25rem 0; color: #666; font-size: 0.9rem;">
                                        {{ formatBytes(sync.file_size_bytes) }} â€¢ 
                                        {{ formatDate(sync.last_sync_time) }}
                                    </p>
                                </div>
                                <div>
                                    <span :class="'status-badge status-' + sync.sync_status">
                                        {{ getStatusText(sync.sync_status) }}
                                    </span>
                                </div>
                            </div>
                            
                            <div v-if="sync.sync_status === 'processing'" class="progress-bar">
                                <div class="progress-fill" :style="{width: getProgressWidth(sync) + '%'}"></div>
                            </div>
                            
                            <div v-if="sync.records_imported > 0" style="color: #666; font-size: 0.9rem;">
                                ğŸ“Š å·²å°å…¥ {{ sync.records_imported.toLocaleString() }} ç­†è¨˜éŒ„åˆ°è¡¨æ ¼ï¼š{{ sync.target_table_name }}
                            </div>
                            
                            <div v-if="sync.error_message" style="color: #ff4d4f; font-size: 0.9rem; margin-top: 0.5rem;">
                                âš ï¸ {{ sync.error_message }}
                            </div>
                            
                            <div class="action-buttons">
                                <el-button size="small" @click="viewTableData(sync.target_table_name)" v-if="sync.target_table_name">
                                    æŸ¥çœ‹æ•¸æ“š
                                </el-button>
                                <el-button size="small" type="primary" @click="retrySyncIfFailed(sync)" v-if="sync.sync_status === 'failed'">
                                    é‡è©¦åŒæ­¥
                                </el-button>
                                <el-button size="small" type="info" @click="viewSyncDetails(sync)">
                                    è©³ç´°ä¿¡æ¯
                                </el-button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æ€§èƒ½åˆ†æåœ–è¡¨ -->
                <div class="content-area">
                    <h3>ğŸ“ˆ åŒæ­¥æ€§èƒ½åˆ†æ</h3>
                    <div class="chart-container">
                        <canvas ref="performanceChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- ç®¡ç†è¡¨æ ¼æ¦‚è¦½ -->
            <div class="content-area full-width">
                <h3>ğŸ—‚ï¸ æ•¸æ“šè¡¨ç®¡ç†æ¦‚è¦½</h3>
                <el-table :data="managedTables" style="width: 100%">
                    <el-table-column prop="table_name" label="è¡¨æ ¼åç¨±" width="200">
                        <template #default="scope">
                            <el-link @click="viewTableData(scope.row.table_name)">
                                {{ scope.row.table_name }}
                            </el-link>
                        </template>
                    </el-table-column>
                    <el-table-column prop="display_name" label="é¡¯ç¤ºåç¨±" width="200">
                    </el-table-column>
                    <el-table-column prop="total_records" label="è¨˜éŒ„æ•¸é‡" width="120">
                        <template #default="scope">
                            {{ scope.row.total_records?.toLocaleString() || 0 }}
                        </template>
                    </el-table-column>
                    <el-table-column prop="estimated_size_mb" label="å¤§å°" width="100">
                        <template #default="scope">
                            {{ (scope.row.estimated_size_mb || 0).toFixed(1) }} MB
                        </template>
                    </el-table-column>
                    <el-table-column prop="last_sync_time" label="æœ€å¾ŒåŒæ­¥" width="180">
                        <template #default="scope">
                            {{ formatDate(scope.row.last_sync_time) }}
                        </template>
                    </el-table-column>
                    <el-table-column prop="sync_status" label="ç‹€æ…‹" width="100">
                        <template #default="scope">
                            <span :class="'status-badge status-' + scope.row.sync_status">
                                {{ getStatusText(scope.row.sync_status) }}
                            </span>
                        </template>
                    </el-table-column>
                    <el-table-column prop="data_quality_score" label="å“è³ªåˆ†æ•¸" width="120">
                        <template #default="scope">
                            <el-progress 
                                :percentage="(scope.row.data_quality_score || 0) * 100" 
                                :stroke-width="6"
                                :show-text="false">
                            </el-progress>
                            {{ ((scope.row.data_quality_score || 0) * 100).toFixed(0) }}%
                        </template>
                    </el-table-column>
                    <el-table-column label="æ“ä½œ" width="200">
                        <template #default="scope">
                            <el-button size="small" @click="viewTableData(scope.row.table_name)">æŸ¥çœ‹</el-button>
                            <el-button size="small" type="primary" @click="exportTableData(scope.row.table_name)">å°å‡º</el-button>
                            <el-button size="small" type="danger" @click="deleteTable(scope.row)">åˆªé™¤</el-button>
                        </template>
                    </el-table-column>
                </el-table>
            </div>
        </div>

        <!-- è¨­ç½®å°è©±æ¡† -->
        <el-dialog v-model="showSettings" title="âš™ï¸ åŒæ­¥è¨­ç½®" width="60%">
            <el-form :model="settings" label-width="120px">
                <el-form-item label="åŒæ­¥é »ç‡">
                    <el-select v-model="settings.syncSchedule">
                        <el-option label="æ¯5åˆ†é˜" value="*/5 * * * *"></el-option>
                        <el-option label="æ¯10åˆ†é˜" value="*/10 * * * *"></el-option>
                        <el-option label="æ¯30åˆ†é˜" value="*/30 * * * *"></el-option>
                        <el-option label="æ¯å°æ™‚" value="0 * * * *"></el-option>
                    </el-select>
                </el-form-item>
                <el-form-item label="æœ€å¤§æ–‡ä»¶å¤§å°">
                    <el-input-number v-model="settings.maxFileSizeMB" :min="1" :max="1000" />
                    <span style="margin-left: 10px;">MB</span>
                </el-form-item>
                <el-form-item label="æ‰¹æ¬¡è™•ç†å¤§å°">
                    <el-input-number v-model="settings.batchSize" :min="100" :max="10000" :step="100" />
                </el-form-item>
                <el-form-item label="è‡ªå‹•å‰µå»ºè¡¨æ ¼">
                    <el-switch v-model="settings.autoCreateTables"></el-switch>
                </el-form-item>
                <el-form-item label="å¤±æ•—æ™‚é€šçŸ¥">
                    <el-switch v-model="settings.notifyOnFailure"></el-switch>
                </el-form-item>
            </el-form>
            <template #footer>
                <el-button @click="showSettings = false">å–æ¶ˆ</el-button>
                <el-button type="primary" @click="saveSettings">ä¿å­˜è¨­ç½®</el-button>
            </template>
        </el-dialog>
    </div>

    <script>
        const { createApp } = Vue;
        const { ElMessage, ElMessageBox } = ElementPlus;

        // Supabase é…ç½®
        const supabase = window.supabase.createClient(
            'YOUR_SUPABASE_URL',
            'YOUR_SUPABASE_ANON_KEY'
        );

        createApp({
            data() {
                return {
                    loading: false,
                    showSettings: false,
                    recentSyncs: [],
                    managedTables: [],
                    stats: {
                        totalFiles: 0,
                        completedToday: 0,
                        processingNow: 0,
                        failedToday: 0,
                        totalDataSize: 0,
                        avgProcessingTime: 0
                    },
                    settings: {
                        syncSchedule: '*/10 * * * *',
                        maxFileSizeMB: 100,
                        batchSize: 1000,
                        autoCreateTables: true,
                        notifyOnFailure: true
                    },
                    performanceChart: null
                }
            },
            async mounted() {
                await this.loadData();
                this.initPerformanceChart();
                
                // è¨­ç½®è‡ªå‹•åˆ·æ–°
                setInterval(() => {
                    this.refreshProcessingStatus();
                }, 30000); // æ¯30ç§’åˆ·æ–°è™•ç†ä¸­çš„åŒæ­¥
            },
            methods: {
                async loadData() {
                    this.loading = true;
                    try {
                        await Promise.all([
                            this.loadRecentSyncs(),
                            this.loadManagedTables(),
                            this.loadStats()
                        ]);
                    } catch (error) {
                        ElMessage.error('è¼‰å…¥è³‡æ–™å¤±æ•—: ' + error.message);
                    }
                    this.loading = false;
                },
                
                async loadRecentSyncs() {
                    const { data, error } = await supabase
                        .from('file_sync_log')
                        .select('*')
                        .order('last_sync_time', { ascending: false })
                        .limit(20);
                    
                    if (error) throw error;
                    this.recentSyncs = data || [];
                },
                
                async loadManagedTables() {
                    const { data, error } = await supabase
                        .from('managed_tables')
                        .select('*')
                        .order('last_sync_time', { ascending: false });
                    
                    if (error) throw error;
                    this.managedTables = data || [];
                },
                
                async loadStats() {
                    const today = new Date().toISOString().split('T')[0];
                    
                    const [files, todayStats] = await Promise.all([
                        supabase.from('file_sync_log').select('*'),
                        supabase.from('file_sync_log')
                            .select('*')
                            .gte('last_sync_time', today)
                    ]);
                    
                    const allFiles = files.data || [];
                    const todayFiles = todayStats.data || [];
                    
                    this.stats = {
                        totalFiles: allFiles.length,
                        completedToday: todayFiles.filter(f => f.sync_status === 'completed').length,
                        processingNow: allFiles.filter(f => f.sync_status === 'processing').length,
                        failedToday: todayFiles.filter(f => f.sync_status === 'failed').length,
                        totalDataSize: allFiles.reduce((sum, f) => sum + (f.file_size_bytes || 0), 0),
                        avgProcessingTime: Math.round(
                            allFiles
                                .filter(f => f.processing_time_ms)
                                .reduce((sum, f, _, arr) => sum + f.processing_time_ms / arr.length, 0) / 1000
                        )
                    };
                },
                
                async refreshProcessingStatus() {
                    // åªåˆ·æ–°è™•ç†ä¸­çš„åŒæ­¥ç‹€æ…‹
                    const processingIds = this.recentSyncs
                        .filter(sync => sync.sync_status === 'processing')
                        .map(sync => sync.id);
                    
                    if (processingIds.length > 0) {
                        const { data } = await supabase
                            .from('file_sync_log')
                            .select('*')
                            .in('id', processingIds);
                        
                        if (data) {
                            data.forEach(updatedSync => {
                                const index = this.recentSyncs.findIndex(s => s.id === updatedSync.id);
                                if (index !== -1) {
                                    this.recentSyncs[index] = updatedSync;
                                }
                            });
                        }
                    }
                },
                
                getFileIcon(fileName) {
                    const ext = fileName.split('.').pop().toLowerCase();
                    switch (ext) {
                        case 'csv': return 'ğŸ“Š';
                        case 'xlsx': case 'xls': return 'ğŸ“ˆ';
                        case 'json': return 'ğŸ“‹';
                        default: return 'ğŸ“„';
                    }
                },
                
                getStatusText(status) {
                    const statusMap = {
                        'completed': 'å·²å®Œæˆ',
                        'processing': 'è™•ç†ä¸­',
                        'failed': 'å¤±æ•—',
                        'pending': 'ç­‰å¾…ä¸­',
                        'active': 'æ´»èº',
                        'error': 'éŒ¯èª¤'
                    };
                    return statusMap[status] || status;
                },
                
                getProgressWidth(sync) {
                    if (sync.sync_status !== 'processing') return 0;
                    
                    // åŸºæ–¼æ™‚é–“ä¼°ç®—é€²åº¦ï¼ˆç°¡åŒ–ç‰ˆï¼‰
                    const elapsed = Date.now() - new Date(sync.last_sync_time).getTime();
                    const estimated = (sync.file_size_bytes || 1000000) / 10000; // ä¼°ç®—è™•ç†æ™‚é–“
                    return Math.min(95, (elapsed / estimated) * 100);
                },
                
                formatBytes(bytes) {
                    if (!bytes) return '0 B';
                    const k = 1024;
                    const sizes = ['B', 'KB', 'MB', 'GB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
                },
                
                formatDate(dateString) {
                    if (!dateString) return 'æœªçŸ¥';
                    return new Date(dateString).toLocaleString('zh-TW');
                },
                
                async triggerManualSync() {
                    try {
                        ElMessage.info('æ­£åœ¨è§¸ç™¼æ‰‹å‹•åŒæ­¥...');
                        // é€™è£¡å¯ä»¥èª¿ç”¨ n8n webhook è§¸ç™¼åŒæ­¥
                        // await fetch('/webhook/trigger-sync', { method: 'POST' });
                        ElMessage.success('æ‰‹å‹•åŒæ­¥å·²è§¸ç™¼ï¼');
                        setTimeout(() => this.refreshData(), 2000);
                    } catch (error) {
                        ElMessage.error('è§¸ç™¼åŒæ­¥å¤±æ•—: ' + error.message);
                    }
                },
                
                viewTableData(tableName) {
                    // é–‹å•Ÿæ–°è¦–çª—æŸ¥çœ‹è¡¨æ ¼æ•¸æ“š
                    window.open(`/table-viewer?table=${tableName}`, '_blank');
                },
                
                async exportTableData(tableName) {
                    try {
                        ElMessage.info('æ­£åœ¨æº–å‚™å°å‡º...');
                        const { data, error } = await supabase
                            .from(tableName)
                            .select('*')
                            .limit(10000);
                        
                        if (error) throw error;
                        
                        const csv = this.convertToCSV(data);
                        this.downloadCSV(csv, `${tableName}.csv`);
                        ElMessage.success('å°å‡ºå®Œæˆï¼');
                    } catch (error) {
                        ElMessage.error('å°å‡ºå¤±æ•—: ' + error.message);
                    }
                },
                
                convertToCSV(data) {
                    if (!data || data.length === 0) return '';
                    const headers = Object.keys(data[0]).join(',');
                    const rows = data.map(row => 
                        Object.values(row).map(val => `"${val}"`).join(',')
                    );
                    return [headers, ...rows].join('\n');
                },
                
                downloadCSV(csv, filename) {
                    const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = filename;
                    link.click();
                },
                
                async deleteTable(table) {
                    try {
                        await ElMessageBox.confirm(
                            `ç¢ºå®šè¦åˆªé™¤è¡¨æ ¼ "${table.table_name}" å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•æ¢å¾©ï¼`,
                            'ç¢ºèªåˆªé™¤'
                        );
                        
                        // åŸ·è¡Œåˆªé™¤æ“ä½œ
                        ElMessage.success('è¡¨æ ¼å·²åˆªé™¤');
                        await this.loadManagedTables();
                    } catch (error) {
                        if (error !== 'cancel') {
                            ElMessage.error('åˆªé™¤å¤±æ•—: ' + error.message);
                        }
                    }
                },
                
                initPerformanceChart() {
                    const ctx = this.$refs.performanceChart.getContext('2d');
                    this.performanceChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: ['1h', '2h', '3h', '4h', '5h', '6h'],
                            datasets: [{
                                label: 'åŒæ­¥æˆåŠŸç‡',
                                data: [95, 87, 92, 89, 94, 96],
                                borderColor: '#667eea',
                                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                                tension: 0.4
                            }, {
                                label: 'è™•ç†é€Ÿåº¦(MB/s)',
                                data: [12, 15, 11, 18, 16, 14],
                                borderColor: '#764ba2',
                                backgroundColor: 'rgba(118, 75, 162, 0.1)',
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                },
                
                async saveSettings() {
                    try {
                        // ä¿å­˜è¨­ç½®åˆ° Supabase
                        ElMessage.success('è¨­ç½®å·²ä¿å­˜ï¼');
                        this.showSettings = false;
                    } catch (error) {
                        ElMessage.error('ä¿å­˜è¨­ç½®å¤±æ•—: ' + error.message);
                    }
                },
                
                async refreshData() {
                    await this.loadData();
                    ElMessage.success('è³‡æ–™å·²åˆ·æ–°ï¼');
                }
            }
        }).use(ElementPlus).mount('#app');
    </script>
</body>
</html>