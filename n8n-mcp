#!/usr/bin/env node

/**
 * ğŸš€ Claude Code n8n-MCP è‡ªå®šä¹‰æŒ‡ä»¤
 * åœ¨ Claude Code ä¸­è¾“å…¥ "n8n-mcp" å³å¯å¿«é€Ÿè¿æ¥MCPå’Œn8nå¹³å°
 */

import { spawn } from 'child_process';
import chalk from 'chalk';
import { readFileSync, existsSync } from 'fs';
import { join } from 'path';

class N8nMcpConnector {
    constructor() {
        this.projectRoot = process.cwd();
        this.mcpConfigPath = join(this.projectRoot, 'claude-desktop-config.json');
    }

    showBanner() {
        console.log(chalk.blue.bold('\nğŸš€ Claude Code n8n-MCP è¿æ¥å™¨'));
        console.log(chalk.gray('â•'.repeat(40)));
    }

    async checkMcpConfig() {
        console.log(chalk.yellow('ğŸ“‹ æ£€æŸ¥MCPé…ç½®...'));
        
        if (!existsSync(this.mcpConfigPath)) {
            console.log(chalk.red('âŒ æœªæ‰¾åˆ°MCPé…ç½®æ–‡ä»¶'));
            return false;
        }

        try {
            const config = JSON.parse(readFileSync(this.mcpConfigPath, 'utf8'));
            if (config.mcpServers && config.mcpServers['n8n-expert']) {
                console.log(chalk.green('âœ… n8n-expert MCPæœåŠ¡å™¨å·²é…ç½®'));
                return true;
            }
        } catch (error) {
            console.log(chalk.red('âŒ MCPé…ç½®è§£æé”™è¯¯'));
        }
        return false;
    }

    async testN8nConnection() {
        console.log(chalk.yellow('ğŸ”Œ æµ‹è¯•n8nè¿æ¥...'));
        
        try {
            const config = JSON.parse(readFileSync(this.mcpConfigPath, 'utf8'));
            const env = config.mcpServers['n8n-expert']?.env;
            
            if (!env || !env.N8N_BASE_URL || !env.N8N_API_KEY) {
                console.log(chalk.red('âŒ MCPé…ç½®ä¸­ç¼ºå°‘n8nè¿æ¥ä¿¡æ¯'));
                return false;
            }

            const response = await fetch(`${env.N8N_BASE_URL}/api/v1/workflows`, {
                headers: {
                    'X-N8N-API-KEY': env.N8N_API_KEY,
                    'Content-Type': 'application/json'
                }
            });

            if (response.ok) {
                const data = await response.json();
                console.log(chalk.green(`âœ… n8nè¿æ¥æˆåŠŸ (${data.data?.length || 0} ä¸ªå·¥ä½œæµ)`));
                console.log(chalk.gray(`   å¹³å°: ${env.N8N_BASE_URL}`));
                return true;
            } else {
                console.log(chalk.red(`âŒ n8n APIå“åº”é”™è¯¯: ${response.status}`));
                return false;
            }
        } catch (error) {
            console.log(chalk.red(`âŒ n8nè¿æ¥å¤±è´¥: ${error.message}`));
        }
        return false;
    }

    initMcp() {
        console.log(chalk.yellow('ğŸ¤– åˆå§‹åŒ–MCPåŠ©æ‰‹...'));
        
        return new Promise((resolve) => {
            const mcpProcess = spawn('npx', ['-y', 'n8n-mcp', '--help'], {
                stdio: 'pipe',
                shell: true
            });

            mcpProcess.on('close', (code) => {
                console.log(chalk.green('âœ… MCPåŠ©æ‰‹å·²å°±ç»ª (535+ n8nèŠ‚ç‚¹çŸ¥è¯†)'));
                resolve(true);
            });

            setTimeout(() => {
                mcpProcess.kill();
                resolve(true);
            }, 3000);
        });
    }

    showUsage() {
        console.log(chalk.blue('\nğŸ“š ç°åœ¨ä½ å¯ä»¥ç›´æ¥åœ¨Claude Codeä¸­è¯¢é—®:'));
        console.log(chalk.white('   â€¢ "å¸®æˆ‘è®¾è®¡ä¸€ä¸ªLINEèŠå¤©æœºå™¨äººå·¥ä½œæµ"'));
        console.log(chalk.white('   â€¢ "æ¨èå¤„ç†CSVæ•°æ®çš„n8nèŠ‚ç‚¹"'));
        console.log(chalk.white('   â€¢ "è¿™ä¸ªå·¥ä½œæµJSONæœ‰ä»€ä¹ˆé—®é¢˜å—ï¼Ÿ"'));
        console.log(chalk.white('   â€¢ "å¦‚ä½•ä¼˜åŒ–è¿™ä¸ªn8nå·¥ä½œæµçš„æ€§èƒ½ï¼Ÿ"'));
        
        console.log(chalk.blue('\nğŸ› ï¸ å·¥ä½œæµç®¡ç†å‘½ä»¤:'));
        console.log(chalk.white('   workflow-manager list          - åˆ—å‡ºæ‰€æœ‰å·¥ä½œæµ'));
        console.log(chalk.white('   workflow-manager create <type> - åˆ›å»ºæ–°å·¥ä½œæµ'));
        console.log(chalk.white('   workflow-manager open current  - æ‰“å¼€å·¥ä½œç›®å½•'));
    }

    async run() {
        this.showBanner();

        const mcpOk = await this.checkMcpConfig();
        if (!mcpOk) {
            console.log(chalk.red('\nâŒ MCPé…ç½®å¼‚å¸¸ï¼Œè¯·æ£€æŸ¥ claude-desktop-config.json'));
            return;
        }

        const n8nOk = await this.testN8nConnection();
        await this.initMcp();

        console.log(chalk.blue('\nğŸ“Š è¿æ¥çŠ¶æ€:'));
        console.log(`   MCPæœåŠ¡å™¨: ${chalk.green('âœ… n8n-expert')}`);
        console.log(`   n8nå¹³å°: ${n8nOk ? chalk.green('âœ… å·²è¿æ¥') : chalk.yellow('âš ï¸ è¿æ¥å¼‚å¸¸')}`);
        console.log(`   AIåŠ©æ‰‹: ${chalk.green('âœ… 535+ èŠ‚ç‚¹çŸ¥è¯†å·²è½½å…¥')}`);

        if (mcpOk) {
            console.log(chalk.green.bold('\nğŸ‰ n8n-MCP å·²å°±ç»ªï¼'));
            this.showUsage();
        }

        console.log(chalk.gray('\nğŸ’¡ æç¤º: MCPä¼šåœ¨Claude Codeå¯åŠ¨æ—¶è‡ªåŠ¨è¿æ¥'));
        console.log('');
    }
}

const connector = new N8nMcpConnector();
connector.run().catch(console.error);